# 교사 콘솔 "수업 악보" 자동 생성 규칙 v0.9

## 1. 목적
- 학습자의 최신 LRC/세션 데이터를 기반으로 **도입 → 탐구 → 전이 → 메타 → 퀵체크** 흐름을 자동 구성하여 교사가 수업을 빠르게 준비하도록 돕는다.
- 렌즈(🔺 차분, ➗ 비율, 🔄 변환)·표현(C/P/A)·컨텍스트(생활/데이터/도형) 메타 정보를 활용해 발문 스크립트, 활동 자료, 반례 카드 등을 추천한다.

## 2. 입력 데이터
| 출처 | 필드 | 설명 |
|------|------|------|
| LRC 평가 | `latest_lrc.focus_concept`, `metrics` | 최근 추천 노드/렌즈 및 정확·RT·설명 지표 |
| 세션 로그 | `problems[]`, `user_answers`, `time_spent` | 최근 학습 문항, 정답 여부, 풀이 시간 |
| 템플릿 메타 | `lens`, `rep`, `ctx`, `tags.micro`, `tags.miscon` | 기저 마이크로스킬/오개념 정보 |
| 콘텐츠 스튜디오 | `make_stimulus()`, `explain_prompts` | 시각 자료, 발문 텍스트, 반례 자료 |

> 데이터는 `teacher_planner_service`에서 GraphQL/REST로 집계하여 `lesson_plan_request` 객체로 전달.

## 3. 상태 결정 로직
1. **핵심 렌즈 선정**
   - 최근 3회 세션에서 맞춤 추천 빈도가 가장 높은 렌즈 1~2개.
   - LRC `metrics`에서 미달 항목이 있는 렌즈 우선.
2. **표현 모드 비중**
   - 최근 정답률이 70% 미만인 표현(C/P/A) 비중을 높여 학습 전이를 유도.
3. **컨텍스트 전환**
   - 동일 컨텍스트 반복을 피하기 위해 최근 사용 컨텍스트를 제외한 전환 우선(생활→데이터→도형 순 환류).

## 4. 단계별 자동 생성 규칙
### 4.1 도입 (5분)
- **목적**: 선행지식 활성화, 핵심 렌즈 소개.
- 규칙:
  - 이전 세션에서 오답률이 높았던 문항 중 `make_stimulus()`로 재생성하여 도입 예시로 사용.
  - 발문 스크립트 템플릿: `"지난 시간에 본 {lens_keyword} 상황 기억나나요? {context_example}에서 어떤 패턴이 있었나요?"`

### 4.2 탐구 (15분)
- **목적**: 렌즈 중심 활동.
- 활동 구성:
  1. **핵심 활동**: `lesson_core_activity` = 추천 렌즈와 표현 조합이 일치하는 템플릿 2종 선택.
  2. **동형 3형제**: 선택된 템플릿의 `ctx`를 순차적으로 생활/데이터/도형으로 파생.
  3. **발문 자동 생성**: 템플릿 `tags.micro`와 `tags.miscon` 활용하여 탐색 질문/오개념 탐지 질문 생성.

### 4.3 전이 (10분)
- **목적**: 다른 렌즈/표현으로 연결.
- 규칙:
  - `lens` 페어링 테이블 (예: 등차↔변화율, 비율↔일차, 좌표↔직선/원) 기준으로 상호 연결 활동 1개 제안.
  - 이전 세션에서 설명 점수가 낮았던 학생의 사례를 활용한 **반례 카드** 제시.

### 4.4 메타 (5분)
- **목적**: 학습 전략 성찰.
- 자동 생성 항목:
  - `explanation_scored` 로그에서 핵심어 매칭 성공/실패 예시 추출.
  - 교사용 발문: `"오늘 {lens_keyword}를 설명할 때 꼭 언급해야 하는 핵심어는 무엇이었나요?"` 등 3개.

### 4.5 퀵체크 (5분)
- **목적**: 즉시 이해도 확인.
- 구성:
  - `pending` 또는 `near` 상태인 학생에게 맞춤 3문항(동형 3형제) 자동 큐레이션.
  - 결과는 `teacher_dashboard`의 "퀵체크" 위젯으로 실시간 반영.

## 5. 출력 데이터 구조
```json
{
  "lesson_plan_id": "2025-10-06-class-4-1",
  "generated_at": "2025-10-06T09:15:00Z",
  "focus_lenses": ["ALG-AP", "ALG-PR"],
  "sequence": [
    {
      "stage": "INTRO",
      "duration_min": 5,
      "stimulus_template": "ALG-AP-S1-002",
      "prompts": [
        "지난 번 점프 수직선을 기억나요? 공차가 왜 일정했는지 이야기해 보세요."
      ]
    },
    {
      "stage": "EXPLORE",
      "duration_min": 15,
      "activities": [
        {
          "template_id": "ALG-AP-S2-018",
          "context_variants": ["life", "data", "geometry"],
          "questions": [
            "그래프에서 공차가 어떻게 보였나요?",
            "기울기를 계산할 때 어떤 순서로 진행했나요?"
          ],
          "miscon_alerts": ["y값=기울기" ]
        }
      ]
    },
    ...
  ],
  "quick_check_items": ["ALG-AP-S1-007", "ALG-PR-S1-008", "GEO-COORD-S1-004"],
  "notes": {
    "meta_reflection": [
      "오늘 문제를 설명할 때 꼭 사용해야 할 핵심어 3개를 적어보게 하세요",
      "학생 설명에서 '기울기=공차' 표현이 누락되면 다시 강조"
    ]
  }
}
```

## 6. UI 연동 포인트
- 교사 콘솔 `수업 악보` 섹션은 단계별 아코디언 뷰로 구성.
- 각 단계 카드에는 `활동 미리보기(make_stimulus)`와 `발문 복사` 버튼 제공.
- 퀵체크 문항은 `Assign to class` 버튼으로 즉시 숙제/라이브 체크로 전송.

## 7. 갱신 스케줄
- 레슨 플랜은 매일 새벽 4시 기준으로 자동 갱신 + 수업 1시간 전 실시간 업데이트.
- 수동 갱신 트리거: 교사 콘솔 상단 `재생성` 버튼 → 백엔드에서 최신 로그 기반 재합성.

## 8. QA 체크리스트
- 렌즈·표현·컨텍스트 매칭이 사양과 일치하는지 검증.
- misCon Alerts가 UI에서 적절히 강조(붉은 배지)되는지 확인.
- 퀵체크 문항 배정 시 중복/이미 완료 문항 제외 로직 확인.

## 9. 향후 개선
- v1.0: 학급별 난이도 보정(IRT θ분포 기반)으로 활동 난이도 자동 조절.
- v1.1: 음성 발문 TTS 지원, 교사-학생 실시간 메모 연동.
- v1.x: AI 코치 요약 기능(수업 후 실제 진행 로그 → 다음 악보 보정).
