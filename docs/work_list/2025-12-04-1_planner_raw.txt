{"task_id":"Task 2025-12-04-1","owner_role":"planner_spec","status":"ok","decision":"approve","spec_md":"## PRD\n### Summary\nRestore the skill tree experience after the broken merge and deliver the responsive layout, tooltip/arrow fixes, and dashboard + practice launch flow defined for 2025-12-03-1 while keeping the FastAPI backend healthy.\n\n### Goals\n1. Reinstate functional `/api/v1/skills/*` endpoints and regression coverage.\n2. Deliver responsive Skill Tree UX (auto-fit, spacing, tooltips, arrows) on `/skills`.\n3. Integrate Student Dashboard with Skill Tree practice launcher and confirmation modal.\n4. Ensure practice launch surfaces per-node metadata (course step, prerequisites, XP) and emits telemetry.\n\n### Success Metrics\n- Backend smoke + pytest and frontend Vitest suites green.\n- QA sign-off on desktop/tablet/mobile Skill Tree render states.\n- Telemetry dashboards capture viewport fit, hover, and practice launch events â‰¥95% of user interactions.\n\n### Users & Use Cases\n- **Students**: explore full skill relationships, inspect node details without overlap, launch targeted practice.\n- **Instructional staff**: trust practice-plan metadata for confirming assigned work, monitor telemetry.\n- **QA/Support**: run smoketests without backend failures.\n\n### Scope\n- Rebuild `app/routers/skills.py` to expose `/tree`, `/nodes/{id}/practice-plan`, and any helper imports.\n- Ensure `tests/test_practice_plan.py` (or successor) exercises happy-path + 404 scenarios.\n- Frontend Skill Tree page auto-fits graph to viewport on load/resize, maintains responsive width, and ensures arrows land on node outlines with increased spacing to avoid collisions.\n- Tooltip/hover system manages stacking context + offsets to avoid overlaps; hovers throttle telemetry.\n- Student Dashboard embeds Skill Tree summary (mini graph or key metrics), launches practice for selected node via modal that summarizes XP/prereqs/course step, replaces legacy S1/S2/S3 copy.\n- Practice session launch request includes selected `node_id`/`course_step_id` and displays metadata upon confirmation.\n- Telemetry events (`skill_tree.viewport_fit`, `skill_tree.hover`, `skill_tree.practice_launch`) fire with payload {user_id, node_id, timestamp, viewport_size, device_type, prereq_count}.\n- Documentation updates: mention new modal flow + endpoints in `docs/` and update telemetry reference if needed.\n\n### Out of Scope\n- Redesigning Skill Tree data schema beyond metadata additions.\n- Changes to practice engine scoring or XP calculation.\n\n### Dependencies\n- Existing bipartite graph loaders and problem bank caches.\n- Student Dashboard data layer (ensure hooks available for embedding Skill Tree data).\n\n## SRS\n### Functional Requirements\n1. **Backend Router Restoration**\n   - Implement FastAPI router under `app/routers/skills.py` with routes:\n     - `GET /api/v1/skills/tree`: returns JSON {nodes, edges, metadata} identical to previous contract including `tier_label`.\n     - `GET /api/v1/skills/nodes/{node_id}/practice-plan`: returns 200 for valid node with payload `{node, prerequisites, prerequisite_summary, practice_launch:{course_step_id, xp_value, recommended_problems}}`; returns 404 JSON `{detail}` when node missing.\n   - Ensure router imports wiring (settings, telemetry, loaders) compile and run under uvicorn + pytest.\n\n2. **Practice Metadata**\n   - Extend server logic to include prerequisites list, XP, and any skill status in response.\n   - Cache-friendly: reuse existing bipartite graphs; expose resets in tests.\n\n3. **Frontend Skill Tree**\n   - Page `/skills` loads graph data, auto-calculates scale to fit viewport both on initial load and window resize with debounced handler (<100ms).\n   - Node spacing increased by configurable multiplier; arrow rendering clamps endpoints to node radius.\n   - Tooltip/hover layer uses portal + collision detection (flip/shift) preventing overlap; ensures detail panel does not cover other nodes.\n   - Hover telemetry fires once per node per page load, with min 500ms dwell before logging.\n\n4. **Student Dashboard Integration**\n   - Dashboard displays Skill Tree summary (selected nodes + progress) and CTA `Practice skill`.\n   - Clicking CTA opens confirmation modal summarizing selected skill, prerequisites, XP, and course step ID; confirm triggers practice session launch via backend or existing practice flow.\n   - Remove hardcoded S1/S2/S3 labels/copy.\n\n5. **Practice Launch Flow**\n   - Frontend sends selected `node_id` + `course_step_id` to practice session start endpoint; handles success by routing user to practice view, handles failure states (404, 409) with toast + retry.\n   - Telemetry `skill_tree.practice_launch` includes metadata above plus whether launch succeeded.\n\n6. **Telemetry**\n   - `skill_tree.viewport_fit` on each auto-fit event; includes scale factor and viewport dimensions.\n   - `skill_tree.hover` on tooltip show with node ID and dwell time.\n   - `skill_tree.practice_launch` on modal confirm with node data + prerequisites count + XP.\n   - Ensure backend instrumentation forwards `X-Request-ID` and OpenTelemetry context.\n\n### Non-Functional Requirements\n- **Performance**: Backend endpoints must respond in <300ms P95 under cached graph; frontend render maintains 60fps for panning/zoom on modern laptops, 30fps on mid-tier mobile.\n- **Security**: Validate node IDs, guard against path traversal, ensure modal cannot launch practice without authenticated session.\n- **Reliability**: Telemetry failures should not block UI; fall back gracefully.\n- **Operability**: Log viewport fit + launch events with structured logging for dashboards; update docs on how to verify events.\n- **Accessibility**: Tooltips reachable via keyboard focus, modal meets WCAG 2.1 AA (focus trap, aria labels).\n\n### Testing Strategy\n- Backend pytest (`tests/test_practice_plan.py`) covers:\n  - `/skills/tree` returns nodes/edges and status 200.\n  - `/skills/nodes/{id}/practice-plan` success + 404.\n  - Telemetry instrumentation invoked (mock emitter) for practice launch.\n- Frontend tests:\n  - Component tests ensuring auto-fit logic called on load/resize.\n  - Tooltip collision logic snapshot or DOM tests.\n  - Modal interaction test verifying metadata and launch payload.\n- Manual QA plan: run `make run` + `npm run dev`, verify `/skills` on desktop + mobile emulator, confirm telemetry hits via network tab/logs.\n\n### Rollout / Monitoring\n- Ship behind feature flag for dashboard integration if needed; toggled via config.\n- Add dashboard alerts for missing telemetry events over 15 minutes.\n- Document recovery procedure for router/test corruption.\n","acceptance_criteria":["`app/routers/skills.py` compiles and serves `/api/v1/skills/tree` plus `/api/v1/skills/nodes/{node_id}/practice-plan` with metadata and 404 handling.","`tests/test_practice_plan.py` (or successor) runs under `pytest -q` and validates practice-plan payload + error cases.","`/skills` view auto-fits the Skill Tree to viewport, increases node spacing, prevents tooltip overlap, and renders arrows to node boundaries on desktop/tablet/mobile.","Student Dashboard embeds Skill Tree summary and launches skill-specific practice sessions via confirmation modal with XP/prereq metadata and no legacy S1/S2/S3 copy.","Telemetry events (`skill_tree.viewport_fit`, `skill_tree.hover`, `skill_tree.practice_launch`) fire with expected payload fields without blocking UX.","QA evidence (screenshots/logs) demonstrates responsive behavior and confirms broken diff-text files are fully restored."],"open_questions":["Should the Student Dashboard embed the full interactive Skill Tree or a summarized subset for performance?","Is the practice launch endpoint identical to the existing practice flow or do we need a new backend route for session creation?","Do we need localization updates for the new modal copy?","What is the fallback behavior if telemetry submission fails (retry vs fire-and-forget)?"],"assumptions":["Backend data schema for nodes already includes `tier_label`, `course_step_id`, `xp_value`, and prerequisites or can be derived without new migrations.","Students access Skill Tree while authenticated; no anonymous access required.","Existing practice engine accepts node/course step metadata without additional validation changes.","Design sign-off for spacing/tooltips provided prior to implementation."],"risks":["Restoring router/test files may accidentally drop legitimate untracked changes if not carefully merged.","Large frontend refactor could introduce regressions in existing Skill Tree interactions (panning/zoom).","Telemetry volume increase might impact logging costs; batching may be required later.","Dashboard embedding could hurt load performance on low-end devices without virtualization."],"artifacts_out":[{"type":"spec","uri":"docs/specs/Task-2025-12-04-1/spec_v1.md"}],"notes":["Focus review on backend router completeness, telemetry payload definitions, and dashboard-modal interaction scope."]}
