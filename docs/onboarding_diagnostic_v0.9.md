# 온보딩 진단 v0.9 스펙

## 1. 목적 & 범위
- 신입 학습자의 초기 실력 추정과 개인화된 시작 노드 추천을 위한 1회성 진단 세션.
- 우선순위 3개 스레드(덧셈→등차, 비율·비례, 좌표→직선/원)를 대상으로 **S1 난이도 문항 3개씩** 출제.
- 결과를 근거로 `ONBOARD → (시작 노드 추천)` 단계의 진입 지점을 결정하며, 이후 스페이싱/인터리빙 큐까지 자동 생성.

## 2. 세션 편성
- 총 9문항, 약 6~7분 소요(문항당 45초 권장 + 피드백 5초).
- 출제 순서는 스레드 간 인터리빙하여 피로도를 낮추고 구조 전이를 점검.

| 슬롯 | 스레드 | 템플릿 ID | 렌즈 | 표현 | 주요 마이크로스킬 | 대표 오개념 |
|------|--------|-----------|------|------|--------------------|--------------|
| 1 | ALG-AP (등차) | `ALG-AP-S1-001` | 🔺 차분 | C→P | 수직선 점프 | 공차=첫항 |
| 2 | ALG-PR (비율) | `ALG-PR-S1-001` | ➗ 비율 | C→P | 배합표, 단위율 말하기 | 차이=비율 |
| 3 | GEO-COORD (좌표) | `GEO-COORD-S1-001` | 🔄 변환 | C→P | 좌표 읽기 | (x,y) 순서 반대 |
| 4 | ALG-AP | `ALG-AP-S1-002` | 🔺 | C→P | 표 채우기 & 설명 | 한번만 더하기 |
| 5 | ALG-PR | `ALG-PR-S1-002` | ➗ | C→P | 묶음비교 | 분모 혼동 |
| 6 | GEO-COORD | `GEO-COORD-S1-002` | 🔄 | C→P | 축 정렬 거리 | 피타고라스 남용 |
| 7 | ALG-AP | `ALG-AP-S1-003` | 🔺 | C→P | 규칙 발견, 차이표 | 불규칙 착각 |
| 8 | ALG-PR | `ALG-PR-S1-003` | ➗ | C→P | 1의 값 계산 | 역수 혼동 |
| 9 | GEO-COORD | `GEO-COORD-S1-003` | 🔄 | C→P | 중점 계산 | 평균 실수 |

> 필요 시 `session_manifest` JSON에 위 ID 목록을 나열하고 `render_order`로 슬롯 순서를 지정한다.

## 3. 사용자 플로우
1. **환영/설명 화면(30초)**
   - 진단 목적, 소요 시간, 정답/오답 즉시 피드백 안내.
   - "가능하면 설명 란에 짧게 이유를 적어 주세요" 안내(선택적).
2. **문항 반복 (슬롯 1~9)**
   - 좌측 자극 + 우측 답안 입력(숫자키 또는 선택지). 45초 타이머.
   - 정답 제출 시 즉시 피드백(정오 + 핵심어 하이라이트). 반례 카드는 진단에서는 비공개.
3. **결과 요약 화면**
   - 스레드별 정확도·평균 응답시간·설명 루브릭 점수(선택 입력 시).
   - 추천 시작 노드/스텝 및 사유 문구 제공.
4. **다음 단계 CTA**
   - `Play 첫 세션 시작` 버튼 → 상태머신 `S1` 또는 `S2`로 분기.
   - `결과 공유` 선택 시 부모/교사 요약 PDF 또는 링크 예약.

## 4. 채점 & 메트릭 수집
- **정확도**: 각 문항 1점. 스레드별 정확도 = (정답 개수 ÷ 3).
- **반응시간(RT)**: 제출 시각 - 문항 진입 시각. 45초 초과 시 오답 처리 및 `timed_out=true`.
- **설명 루브릭(선택)**: 간단한 텍스트 필드 사용. 핵심어 일치 시 1점, 구조 언급 시 추가 1점(최대 2점). 미입력은 `null`.
- 이벤트 로깅 표준(테스트 모드):
  - `attempt_submitted` (정오, RT, timed_out, streak=진단은 false)
  - `explanation_scored` (루브릭 세부항목: keyword_match, structure)
  - `diagnostic_completed` (summary payload)

## 5. 추천 로직 (v0.9)
스레드별 성과를 기반으로 다음 중 하나를 추천한다.

| 조건 | 추천 | 추가 액션 |
|-------|-------|------------|
| 정확도 ≥ 80% **및** 평균 RT ≤ 30초 | `S2` 시작 | 해당 노드 S2 세션 큐 생성, 복습 2일 후 알림 예약 |
| 정확도 50~79% 또는 RT 30~40초 | `S1` 시작 | 기본 S1 세션, 핵심 키워드 팁 제공 |
| 정확도 < 50% 또는 RT > 40초 | 프리 스킬 드릴 (원자 스킬) | `원자 스킬 드릴` 모듈 선행 후 다시 S1 |

- 전체 추천은 3개 스레드 중 **가장 낮은 단계**를 우선으로 결정(보수적 접근).
- 다만 한 스레드만 낮고 나머지 2개가 상위 조건이면 혼합 추천 가능 (예: ALG-AP→S2, 나머지→S1).
- 추천 데이터 구조 예시:
```json
{
  "user_id": "...",
  "evaluated_at": "2025-10-06T09:00:00Z",
  "threads": {
    "ALG-AP": {"accuracy": 0.67, "avg_rt": 28.5, "recommendation": "S1"},
    "ALG-PR": {"accuracy": 1.0, "avg_rt": 24.1, "recommendation": "S2"},
    "GEO-COORD": {"accuracy": 0.33, "avg_rt": 38.0, "recommendation": "ATOM"}
  },
  "overall_focus": "GEO-COORD",
  "next_session_entry": "ATOM"
}
```

## 6. 데이터 구조 (콘텐츠 스튜디오 → 앱)
- **manifest** 예시:
```json
{
  "diagnostic_id": "v0.9",
  "items": [
    {"slot": 1, "template_id": "ALG-AP-S1-001", "time_limit": 45},
    ...
    {"slot": 9, "template_id": "GEO-COORD-S1-003", "time_limit": 45}
  ],
  "scoring": {
    "pass_threshold": 0.8,
    "pending_threshold": 0.5,
    "rt_fast": 30,
    "rt_slow": 40
  }
}
```
- 설명 필드는 `attempt.explanation`로 수집, 루브릭은 서버 측 `evaluate_explanation()` 호출 (비동기 가능).

## 7. UX 세부 사항
- 컬러/아이콘은 본 세션 플레이어와 동일(렌즈 토글은 고정 노출).
- 각 문항 종료 시 `다음` 버튼 1초 딜레이(우발적 연타 방지).
- 접근성: 타이머는 텍스트와 프로그레스 바 동시 제공, 키보드 `Enter`로 제출 지원.

## 8. QA 체크리스트
- 9문항 모두 로드되는지 및 템플릿 파라미터가 정상 랜더링되는지.
- 타임아웃 처리 후 다음 문항 이동/로그 기록 검증.
- 추천 JSON이 LRC 평가 모듈과 양립하는지 (필드명 충돌 여부).

## 9. 향후 개선 TODO
- v1.0: 동형 3형제 중 1개씩 진단 문항에 포함하여 설명 기반 평가 강화.
- v1.0: 오답 시 즉시 반례 카드 제공 + 짧은 해설 클립.
- v1.x: 음성 설명 자동 전사(ASR) 연계 후 루브릭 확장.
