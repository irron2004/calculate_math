{% extends "base.html" %}

{% block title %}{{ category_display }} ë¬¸ì œ â€” 360Me Math Lab{% endblock %}

{% block content %}
<div class="mx-auto w-full max-w-5xl space-y-12 px-4 py-12 sm:px-6 lg:px-8" data-problem-container data-category="{{ category or '' }}">
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-sky-500 via-primary to-purple-500 px-6 py-14 text-white shadow-2xl sm:px-10">
        <div class="absolute inset-0 opacity-15" aria-hidden="true"
             style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.28) 0, transparent 55%),
                    radial-gradient(circle at 80% 10%, rgba(255,255,255,0.2) 0, transparent 45%);"></div>
        <div class="relative z-10 space-y-5 text-center">
            <span class="inline-flex items-center justify-center rounded-full bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-widest text-white/80">
                Practice Stage Â· {{ category_display }} Â· WCAG 2.2 AA
            </span>
            <h1 class="text-4xl font-bold tracking-tight sm:text-5xl">{{ category_display }} ë¬¸ì œ ì—°ìŠµ</h1>
            <p class="text-base text-white/85 sm:text-lg">
                ë¬¸ì œë¥¼ ì½ê³  ë‹µì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤. Self â†’ Invite â†’ Aggregate ì—¬ì •ì˜ Practice ë‹¨ê³„ì— í•´ë‹¹í•©ë‹ˆë‹¤.
                ì •ë‹µë¥  ìš”ì•½ê³¼ í•™ìŠµ ë…¸íŠ¸ ë§í¬ë¡œ ë‹¤ìŒ ë‹¨ê³„ì— ëŒ€ë¹„í•˜ì„¸ìš”.
            </p>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <a href="/" class="inline-flex items-center gap-2 rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-white">
                    <span aria-hidden="true">ğŸ </span> í—ˆë¸Œ í™ˆ
                </a>
                <a href="/skills" class="inline-flex items-center gap-2 rounded-full border border-white/40 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/10">
                    <span aria-hidden="true">ğŸŒ³</span> ìŠ¤í‚¬ íŠ¸ë¦¬ ì‚´í´ë³´ê¸°
                </a>
                {% if hub_url %}
                <a href="{{ hub_url }}" class="inline-flex items-center gap-2 rounded-full border border-white/40 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/10" target="_blank" rel="noopener">
                    <span aria-hidden="true">ğŸŒ</span> 360Me Hubë¡œ ì´ë™
                </a>
                {% endif %}
            </div>
        </div>
    </section>

    {% set icon_map = {
        "ë§ì…ˆ": "â•",
        "ëº„ì…ˆ": "â–",
        "ê³±ì…ˆ": "âœ–ï¸",
        "ë‚˜ëˆ—ì…ˆ": "â—"
    } %}
    {% set lens_map = {
        "ë§ì…ˆ": {"icon": "ğŸ”º", "label": "ì°¨ë¶„ ë Œì¦ˆ"},
        "ëº„ì…ˆ": {"icon": "ğŸ”º", "label": "ì°¨ë¶„ ë Œì¦ˆ"},
        "ê³±ì…ˆ": {"icon": "â—", "label": "ë¹„ìœ¨ ë Œì¦ˆ"},
        "ë‚˜ëˆ—ì…ˆ": {"icon": "â—", "label": "ë¹„ìœ¨ ë Œì¦ˆ"}
    } %}
    {% set context_map = {
        "life": {"icon": "ğŸ ", "label": "ìƒí™œ"},
        "data": {"icon": "ğŸ“Š", "label": "ë°ì´í„°"},
        "geometry": {"icon": "ğŸ“", "label": "ë„í˜•"}
    } %}
    {% set representation_map = {
        "P": {"icon": "ğŸ“Š", "label": "í‘œ"},
        "C": {"icon": "ğŸ’¬", "label": "ì„¤ëª…"},
        "A": {"icon": "ğŸ§®", "label": "ì‹"}
    } %}
    {% set current_lens = lens_map.get(category) %}
    <nav aria-label="ì—°ì‚° ìœ í˜•" class="flex flex-wrap items-center justify-center gap-3">
        {% if categories %}
        {% for label in categories %}
        {% set icon = icon_map.get(label, "ğŸ“˜") %}
        {% set lens = lens_map.get(label) %}
        <a href="/problems?category={{ label }}" class="inline-flex items-center gap-3 rounded-full px-4 py-2 text-sm font-semibold transition {% if label == category %}bg-primary text-slate-900 shadow-lg shadow-sky-900/30{% else %}border border-white/20 text-slate-200 hover:bg-white/10{% endif %}">
            <span aria-hidden="true">{{ icon }}</span> {{ label }}
            {% if lens %}
            <span class="inline-flex items-center gap-1 rounded-full bg-black/10 px-2 py-0.5 text-[0.7rem] font-medium uppercase tracking-widest text-white/80">
                <span aria-hidden="true">{{ lens.icon }}</span>
                <span>{{ lens.label }}</span>
            </span>
            {% endif %}
        </a>
        {% endfor %}
        {% else %}
        <span class="rounded-full border border-white/20 px-4 py-2 text-sm font-semibold text-slate-300">í™œì„±í™”ëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</span>
        {% endif %}
    </nav>

    <section aria-labelledby="section-problems" class="space-y-6">
        <header>
            <h2 id="section-problems" class="text-2xl font-semibold text-white sm:text-3xl">ì´ {{ problems|length }}ê°œì˜ {{ category_display }} ë¬¸ì œ</h2>
            <p class="mt-2 text-sm text-slate-300">í¬ì»¤ìŠ¤ ì´ë™ê³¼ í‚¤ë³´ë“œ ì…ë ¥ì„ ì§€ì›í•˜ë©°, ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤.</p>
            {% if problem_generation %}
            <p class="mt-1 text-xs text-slate-400">
                ì—°ì‚°: {{ problem_generation.operation }} Â· ìë¦¿ìˆ˜ {{ problem_generation.digits }} Â· ë¬¸í•­ ìˆ˜ {{ problem_generation.count }}{% if problem_generation.seed is not none %} Â· seed {{ problem_generation.seed }}{% endif %}
            </p>
            {% endif %}
        </header>
        <div class="space-y-5" data-problem-list>
            {% for problem in problems %}
            <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-6 shadow-lg shadow-sky-900/5" data-problem-card data-problem-index="{{ loop.index0 }}" data-problem-id="{{ problem.id }}">
                <header class="flex flex-wrap items-center justify-between gap-3">
                    <h3 class="flex items-center gap-3 text-xl font-semibold text-white">
                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-primary/20 text-base font-semibold text-primary">{{ loop.index }}</span>
                        <span>ë¬¸ì œ {{ loop.index }}: {{ problem.question }}</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        {% if current_lens %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-primary/15 px-3 py-1 text-xs font-semibold text-primary">
                            <span aria-hidden="true">{{ current_lens.icon }}</span>
                            <span>{{ current_lens.label }}</span>
                        </span>
                        {% endif %}
                        {% set context_meta = context_map.get(problem.ctx) %}
                        {% if context_meta %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white/80">
                            <span aria-hidden="true">{{ context_meta.icon }}</span>
                            <span>{{ context_meta.label }}</span>
                        </span>
                        {% endif %}
                        <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white/70">ì¦‰ì‹œ ì±„ì </span>
                    </div>
                </header>
                <form class="mt-5 grid grid-cols-1 gap-4 md:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)_auto] md:items-end" data-problem-form>
                    <label for="answer-{{ loop.index }}" class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">ì •ë‹µ</span>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" id="answer-{{ loop.index }}" class="w-full rounded-xl border border-white/15 bg-slate-950/60 px-4 py-3 text-lg text-white placeholder:text-slate-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" data-input>
                    </label>
                    <label for="explanation-{{ loop.index }}" class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">ì„¤ëª… <span class="text-slate-500">(ì„ íƒ)</span></span>
                        <input type="text" id="explanation-{{ loop.index }}" class="w-full rounded-xl border border-white/15 bg-slate-950/40 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ì–´ë–»ê²Œ í’€ì—ˆë‚˜ìš”?" maxlength="180" data-explanation>
                    </label>
                    <button type="button" class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-check>
                        <span aria-hidden="true">âœ…</span> ë‹µ í™•ì¸
                    </button>
                </form>
                <p class="mt-3 text-sm text-slate-300" data-feedback role="status"></p>
            </article>
            {% endfor %}
        </div>
    </section>

    <section aria-labelledby="section-summary" class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 id="section-summary" class="text-2xl font-semibold text-white">í•™ìŠµ ê²°ê³¼ ìš”ì•½</h2>
                <p class="mt-1 text-sm text-slate-300">ì •ë‹µ ìˆ˜ì™€ ì •í™•ë„ë¥¼ í™•ì¸í•˜ê³ , Invite ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ì¤€ë¹„ë¥¼ ë§ˆì¹©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white transition hover:bg-white/10" data-reset>
                <span aria-hidden="true">ğŸ”„</span> ê²°ê³¼ ì´ˆê¸°í™”
            </button>
        </header>
        <dl class="mt-6 grid gap-4 sm:grid-cols-5 text-center">
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì´ ë¬¸ì œ</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-total">{{ problems|length }}</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µ ìˆ˜</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-correct">0</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µë¥ </dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-accuracy">0%</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">í‰ê·  ë°˜ì‘ì‹œê°„</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-average">â€”</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì„¤ëª… ì…ë ¥ë¥ </dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-explanation">0%</dd>
            </div>
        </dl>
        <p class="mt-4 text-xs text-slate-400">Tip: ì •í™•ë„ 85% ì´ìƒì— ë¹ ë¥¸ ë°˜ì‘(40%+) ë˜ëŠ” ì„¤ëª… ì…ë ¥ë¥  50% ì´ìƒì´ë©´ Invite ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆì–´ìš”.</p>
    </section>

    {% if bridge_unit %}
    <section class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10" data-bridge-unit data-bridge-sequence="{{ bridge_unit.sequence_id }}">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 class="text-2xl font-semibold text-white">S2 ë¸Œë¦¬ì§€ ë¯¸ë‹ˆ ìœ ë‹›</h2>
                <p class="mt-1 text-sm text-slate-300">{{ bridge_unit.description or 'í‘œ â†’ ë§ â†’ ì‹ìœ¼ë¡œ í‘œí˜„ì„ ì „í™˜í•˜ë©° ì „ì´ë¥¼ ì—°ìŠµí•´ë³´ì„¸ìš”.' }}</p>
            </div>
            <div class="inline-flex items-center gap-2 rounded-full bg-primary/15 px-3 py-1 text-xs font-semibold text-primary">
                <span aria-hidden="true">{{ bridge_unit.lens or 'ğŸ”º' }}</span>
                <span>{{ bridge_unit.node }}</span>
            </div>
        </header>
        <p class="mt-4 text-sm text-slate-300" data-bridge-status>í‘œ(P) â†’ ì„¤ëª…(C) â†’ ì‹(A) ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤. ê° ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ê°€ ê°•ì¡°ë©ë‹ˆë‹¤.</p>
        <ol class="mt-4 flex flex-wrap items-center gap-2 text-sm" data-bridge-progress>
            {% for bridge_problem in bridge_unit.problems %}
            {% set rep_meta = representation_map.get(bridge_problem.representation, {'icon': 'ğŸ“˜', 'label': bridge_problem.representation}) %}
            <li class="inline-flex items-center gap-2 rounded-full border border-white/15 px-3 py-1 text-xs font-semibold text-white/80" data-bridge-step data-bridge-index="{{ loop.index0 }}">
                <span aria-hidden="true">{{ rep_meta.icon }}</span>
                <span>{{ loop.index }}ë‹¨ê³„ Â· {{ rep_meta.label }}</span>
            </li>
            {% endfor %}
        </ol>
        <div class="mt-6 space-y-6" data-bridge-problem-list>
            {% for bridge_problem in bridge_unit.problems %}
            {% set rep_meta = representation_map.get(bridge_problem.representation, {'icon': 'ğŸ“˜', 'label': bridge_problem.representation}) %}
            <article class="rounded-2xl border border-white/10 bg-slate-950/60 p-5 shadow-inner" data-bridge-problem data-bridge-index="{{ loop.index0 }}" data-bridge-id="{{ bridge_problem.id }}" data-bridge-type="{{ bridge_problem.type }}"
                {% if bridge_problem.type == 'table_fill' %}
                    data-answer-missing="{{ bridge_problem.answer.missing_value }}"
                    data-answer-difference="{{ bridge_problem.answer.common_difference }}"
                {% elif bridge_problem.type == 'explain' %}
                    data-answer-keywords="{{ bridge_problem.answer_keywords|join('|') }}"
                {% elif bridge_problem.type == 'general_term' %}
                    data-answer-value="{{ bridge_problem.answer }}"
                {% endif %}>
                <header class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-3 text-white">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-primary/20 text-sm font-semibold text-primary">{{ loop.index }}</span>
                        <div>
                            <h3 class="text-lg font-semibold">{{ bridge_problem.prompt }}</h3>
                            <p class="text-xs text-slate-400">í‘œí˜„: {{ rep_meta.label }}</p>
                        </div>
                    </div>
                    <div class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white/70">
                        <span aria-hidden="true">{{ rep_meta.icon }}</span>
                        <span>{{ rep_meta.label }}</span>
                    </div>
                </header>
                <div class="mt-4 space-y-4">
                    {% if bridge_problem.type == 'table_fill' %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-fixed text-center text-sm text-white">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th scope="col" class="px-3 py-2 font-semibold">n</th>
                                    <th scope="col" class="px-3 py-2 font-semibold">aâ‚™</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in bridge_problem.table %}
                                <tr class="border-b border-white/10">
                                    <td class="px-3 py-2 text-slate-300">{{ row[0] }}</td>
                                    <td class="px-3 py-2">
                                        {% if row[1] is none %}
                                        <input type="number" inputmode="numeric" class="w-full rounded-lg border border-white/20 bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ê°’" data-bridge-input="missing">
                                        {% else %}
                                        <span class="text-white">{{ row[1] }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <form class="grid gap-3 sm:grid-cols-2" data-bridge-form>
                        <label class="flex flex-col gap-2 text-sm text-slate-200">
                            <span>ë¹ˆì¹¸ ê°’</span>
                            <input type="number" inputmode="numeric" class="rounded-lg border border-white/20 bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ì˜ˆ: 7" data-bridge-input="missing-value">
                        </label>
                        <label class="flex flex-col gap-2 text-sm text-slate-200">
                            <span>ê³µì°¨</span>
                            <input type="number" inputmode="numeric" class="rounded-lg border border-white/20 bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ì˜ˆ: 2" data-bridge-input="difference">
                        </label>
                        <div class="sm:col-span-2">
                            <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-primary px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-bridge-submit>
                                <span aria-hidden="true">âœ…</span> ë‹µ í™•ì¸
                            </button>
                        </div>
                    </form>
                    {% elif bridge_problem.type == 'explain' %}
                    <form class="space-y-3" data-bridge-form>
                        <label class="flex flex-col gap-2 text-sm text-slate-200">
                            <span>ê·œì¹™ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•´ë³´ì„¸ìš”.</span>
                            <textarea rows="3" class="w-full rounded-lg border border-white/20 bg-slate-900/60 px-3 py-2 text-sm text-white placeholder:text-slate-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ì²« í•­ê³¼ ê³µì°¨ë¥¼ ì–¸ê¸‰í•´ë³´ì„¸ìš”." maxlength="200" data-bridge-input="explanation"></textarea>
                        </label>
                        <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-primary px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-bridge-submit>
                            <span aria-hidden="true">ğŸ“</span> ì„¤ëª… í™•ì¸
                        </button>
                    </form>
                    {% elif bridge_problem.type == 'general_term' %}
                    <div class="space-y-3 text-sm text-slate-300">
                        {% if bridge_problem.given %}
                        <p>ì£¼ì–´ì§„ ê°’: aâ‚ = {{ bridge_problem.given.a1 }}, d = {{ bridge_problem.given.d }}, n = {{ bridge_problem.given.n }}</p>
                        {% endif %}
                        <form class="flex flex-wrap items-end gap-3" data-bridge-form>
                            <label class="flex flex-col gap-2 text-sm text-slate-200">
                                <span>aâ‚™ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</span>
                                <input type="number" inputmode="numeric" class="rounded-lg border border-white/20 bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ì˜ˆ: 13" data-bridge-input="term-value">
                            </label>
                            <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-primary px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-bridge-submit>
                                <span aria-hidden="true">âœ…</span> ë‹µ í™•ì¸
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    {% if bridge_problem.hints %}
                    <details class="rounded-xl border border-white/10 bg-slate-900/40 p-4 text-sm text-slate-200">
                        <summary class="cursor-pointer font-semibold text-white">íŒíŠ¸ ë³´ê¸°</summary>
                        <ul class="mt-2 list-disc space-y-1 pl-5">
                            {% for hint in bridge_problem.hints %}
                            <li>{{ hint }}</li>
                            {% endfor %}
                        </ul>
                    </details>
                    {% endif %}
                    {% if bridge_problem.solution_steps %}
                    <details class="rounded-xl border border-white/10 bg-slate-900/40 p-4 text-sm text-slate-200">
                        <summary class="cursor-pointer font-semibold text-white">í’€ì´ ë‹¨ê³„</summary>
                        <ol class="mt-2 list-decimal space-y-1 pl-5">
                            {% for step in bridge_problem.solution_steps %}
                            <li>{{ step }}</li>
                            {% endfor %}
                        </ol>
                    </details>
                    {% endif %}
                </div>
                <p class="mt-3 text-sm text-slate-300" data-bridge-feedback role="status"></p>
            </article>
            {% endfor %}
        </div>
        <div class="mt-8 hidden rounded-2xl border border-white/10 bg-white/5 p-5" data-bridge-summary>
            <h3 class="text-lg font-semibold text-white">ë¯¸ë‹ˆ ë¦¬í¬íŠ¸</h3>
            <dl class="mt-4 grid gap-3 text-sm text-slate-200 sm:grid-cols-2">
                <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-3">
                    <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">ì™„ë£Œí•œ ë‹¨ê³„</dt>
                    <dd class="mt-2 text-xl font-semibold text-white" data-bridge-summary-count>0 / {{ bridge_unit.problems|length }}</dd>
                </div>
                <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-3">
                    <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">ì •í™•ë„</dt>
                    <dd class="mt-2 text-xl font-semibold text-white" data-bridge-summary-accuracy>0%</dd>
                </div>
                <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-3">
                    <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">í‰ê·  ë°˜ì‘ì‹œê°„</dt>
                    <dd class="mt-2 text-xl font-semibold text-white" data-bridge-summary-average>â€”</dd>
                </div>
                <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-3">
                    <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">ë¹ ë¥¸ ì‘ë‹µ ë¹„ì¤‘</dt>
                    <dd class="mt-2 text-xl font-semibold text-white" data-bridge-summary-fast>â€”</dd>
                </div>
                <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-3">
                    <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">ì„¤ëª… í‚¤ì›Œë“œ</dt>
                    <dd class="mt-2 text-xl font-semibold text-white" data-bridge-summary-explanation>â€”</dd>
                </div>
            </dl>
            <p class="mt-4 text-xs text-slate-300" data-bridge-summary-note>ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ë©´ ìš”ì•½ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
        </div>
    </section>
    {% endif %}

    <section id="invite" data-invite-section data-category="{{ category or '' }}" data-category-available="{{ 'true' if category_available else 'false' }}" tabindex="-1" class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10 focus:outline-none">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 class="text-2xl font-semibold text-white">Invite ë§í¬ ê³µìœ </h2>
                <p class="mt-1 text-sm text-slate-300">í˜„ì¬ ìŠ¤í…Œì´ì§€ ì§„í–‰ ìƒí™©ì„ ê³µìœ í•˜ê³ , ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ì—ê²Œ {{ category_display }} ë¬¸ì œë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button type="button" class="inline-flex items-center gap-2 rounded-full bg-primary px-4 py-2 text-xs font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-sky-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-generate data-label-default="ì´ˆëŒ€ ë§í¬ ìƒì„±" data-label-refresh="ì´ˆëŒ€ ë§í¬ ë‹¤ì‹œ ìƒì„±">
                    <span aria-hidden="true">ğŸ¤</span>
                    <span data-label>ì´ˆëŒ€ ë§í¬ ìƒì„±</span>
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white transition hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-copy disabled>
                    <span aria-hidden="true">ğŸ“‹</span> ë§í¬ ë³µì‚¬
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white/70 transition hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-expire disabled>
                    <span aria-hidden="true">ğŸ—‘ï¸</span> ì´ˆëŒ€ ë§Œë£Œ
                </button>
            </div>
        </header>
        <p class="mt-4 text-sm text-slate-300" data-invite-status role="status">
            {% if category_available %}
            ì •í™•ë„ 85% ì´ìƒì´ê³  ë¹ ë¥¸ ì‘ë‹µ(40%+) ë˜ëŠ” ì„¤ëª… ì…ë ¥ë¥  50% ì´ìƒì´ë©´ Inviteë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            {% else %}
            ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•´ì•¼ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.
            {% endif %}
        </p>
        <div class="mt-6 hidden gap-6 lg:grid lg:grid-cols-[1.3fr_1fr]" data-invite-result>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
                <h3 class="text-lg font-semibold text-white">ê³µìœ  ë§í¬</h3>
                <a data-invite-url href="#" target="_blank" rel="noopener" class="mt-3 inline-block break-all text-sm text-sky-300 underline underline-offset-4">ì´ˆëŒ€ ë§í¬ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</a>
                <p class="mt-3 text-xs text-slate-300">ë§Œë£Œ ì˜ˆì •: <span data-invite-expiry>â€”</span></p>
                <dl class="mt-6 grid grid-cols-3 gap-3 text-center md:grid-cols-5">
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì´ ë¬¸ì œ</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-total>0</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì •ë‹µ</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-correct>0</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì •ë‹µë¥ </dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-accuracy>0%</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">í‰ê·  ë°˜ì‘</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-average>â€”</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ë¹ ë¥¸ ì‘ë‹µ Â· ì„¤ëª…</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-fast>â€”</dd>
                        <dd class="text-xs text-slate-300" data-invite-summary-explanation>â€”</dd>
                    </div>
                </dl>
            </div>
            <div class="flex flex-col items-center justify-center gap-4 rounded-2xl border border-white/10 bg-white/5 p-6 text-center">
                <p class="text-sm text-slate-300">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì´ˆëŒ€ ë§í¬ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <img data-invite-qr src="" alt="ì´ˆëŒ€ ë§í¬ QR ì½”ë“œ" class="hidden h-44 w-44 rounded-xl border border-white/20 bg-white/80 p-3 shadow-lg shadow-sky-900/20" loading="lazy" />
            </div>
        </div>
    </section>
</div>

<script>
const problemCards = Array.from(document.querySelectorAll('[data-problem-card]'));
const problemData = {{ problems|tojson }};
const bridgeUnit = {{ bridge_unit|default(None)|tojson }};
const summaryCorrect = document.getElementById('summary-correct');
const summaryAccuracy = document.getElementById('summary-accuracy');
const summaryTotal = document.getElementById('summary-total');
const summaryAverage = document.getElementById('summary-average');
const summaryExplanation = document.getElementById('summary-explanation');
const answered = new Map();
const explanations = new Map();
const attemptTimings = new Map();
const reactionTimes = new Map();
const pageContainer = document.querySelector('[data-problem-container]');
const currentCategory = pageContainer && pageContainer.dataset && pageContainer.dataset.category
    ? pageContainer.dataset.category
    : null;

const MIN_ACCURACY_PERCENT = 85;
const FAST_THRESHOLD_MS = 6000;
const FAST_RATIO_THRESHOLD = 0.4;
const EXPLANATION_COVERAGE_THRESHOLD = 0.5;
const bridgeSection = document.querySelector('[data-bridge-unit]');
const bridgeStepElements = bridgeSection
    ? Array.from(bridgeSection.querySelectorAll('[data-bridge-step]'))
    : [];
const bridgeProblems = bridgeSection
    ? Array.from(bridgeSection.querySelectorAll('[data-bridge-problem]'))
    : [];
const bridgeStatus = bridgeSection
    ? bridgeSection.querySelector('[data-bridge-status]')
    : null;
const bridgeSummary = bridgeSection
    ? bridgeSection.querySelector('[data-bridge-summary]')
    : null;
const bridgeSummaryCount = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-count]')
    : null;
const bridgeSummaryAccuracy = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-accuracy]')
    : null;
const bridgeSummaryAverage = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-average]')
    : null;
const bridgeSummaryFast = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-fast]')
    : null;
const bridgeSummaryExplanation = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-explanation]')
    : null;
const bridgeSummaryNote = bridgeSummary
    ? bridgeSummary.querySelector('[data-bridge-summary-note]')
    : null;
const bridgeTimers = new Map();
const bridgeResults = new Map();
const bridgeExplanationStore = new Map();

function trackProblemRTEvent(payload) {
    if (window.analytics && typeof window.analytics.trackProblemRT === 'function') {
        window.analytics.trackProblemRT(payload);
    } else {
        console.debug('problem:rt', payload);
    }
}

function trackProblemExplanationEvent(payload) {
    if (window.analytics && typeof window.analytics.trackProblemExplanation === 'function') {
        window.analytics.trackProblemExplanation(payload);
    } else {
        console.debug('problem:explanation', payload);
    }
}

function markProblemStart(problemId) {
    if (!problemId) {
        return;
    }
    attemptTimings.set(problemId, { startedAt: performance.now() });
}

function collectSessionMetrics() {
    const total = problemData.length || problemCards.length;
    const correctCount = Array.from(answered.values()).reduce(
        (acc, value) => acc + (value ? 1 : 0),
        0,
    );
    const durations = Array.from(reactionTimes.values()).filter((value) => Number.isFinite(value));
    const totalDuration = durations.reduce((acc, value) => acc + value, 0);
    const averageMs = durations.length ? totalDuration / durations.length : null;
    const fastCount = durations.filter((value) => value <= FAST_THRESHOLD_MS).length;
    const fastRatio = durations.length ? fastCount / durations.length : null;
    const explanationCount = explanations.size;
    const explanationCoverage = total > 0 ? explanationCount / total : 0;

    return {
        total,
        correctCount,
        averageMs,
        fastRatio,
        explanationCount,
        explanationCoverage,
    };
}

function renderSummary() {
    const metrics = collectSessionMetrics();
    const accuracy = metrics.total === 0 ? 0 : Math.round((metrics.correctCount / metrics.total) * 100);
    if (summaryCorrect) {
        summaryCorrect.textContent = String(metrics.correctCount);
    }
    if (summaryAccuracy) {
        summaryAccuracy.textContent = `${accuracy}%`;
    }
    if (summaryTotal) {
        summaryTotal.textContent = String(metrics.total);
    }
    if (summaryAverage) {
        if (metrics.averageMs === null) {
            summaryAverage.textContent = 'â€”';
        } else {
            const seconds = (metrics.averageMs / 1000).toFixed(1);
            summaryAverage.textContent = `${seconds}ì´ˆ`;
        }
    }
    if (summaryExplanation) {
        const coveragePercent = Math.round(metrics.explanationCoverage * 100);
        summaryExplanation.textContent = `${coveragePercent}%`;
    }
}

function trackBridgeAnalytics(eventName, payload) {
    if (window.analytics && typeof window.analytics.trackEvent === 'function') {
        window.analytics.trackEvent(eventName, payload);
    } else {
        console.debug(eventName, payload);
    }
}

function setBridgeFeedback(article, message, toneClass) {
    const feedback = article.querySelector('[data-bridge-feedback]');
    if (!feedback) {
        return;
    }
    feedback.textContent = message;
    feedback.className = `mt-3 text-sm font-semibold ${toneClass}`;
}

function startBridgeTimer(problemId) {
    if (!problemId || bridgeTimers.has(problemId)) {
        return;
    }
    bridgeTimers.set(problemId, performance.now());
}

function finishBridgeTimer(problemId) {
    if (!problemId) {
        return null;
    }
    const startedAt = bridgeTimers.get(problemId);
    if (typeof startedAt !== 'number') {
        return null;
    }
    const elapsed = Math.max(0, performance.now() - startedAt);
    bridgeTimers.delete(problemId);
    return elapsed;
}

function updateBridgeProgress() {
    bridgeStepElements.forEach((stepEl) => {
        const index = Number(stepEl.dataset.bridgeIndex || '0');
        const problem = bridgeProblems[index];
        const problemId = problem ? problem.dataset.bridgeId : null;
        const result = problemId ? bridgeResults.get(problemId) : null;
        stepEl.classList.remove('bg-primary', 'text-slate-900', 'border-white/15', 'bg-white/10', 'text-white/80');
        if (result && result.correct) {
            stepEl.classList.add('bg-primary', 'text-slate-900');
        } else {
            stepEl.classList.add('bg-white/10', 'text-white/80');
        }
    });
}

function updateBridgeSummary() {
    if (!bridgeSummary) {
        return;
    }
    const total = bridgeProblems.length;
    const completed = Array.from(bridgeResults.values()).filter((entry) => entry.correct).length;
    const accuracy = total === 0 ? 0 : Math.round((completed / total) * 100);
    const durations = Array.from(bridgeResults.values())
        .map((entry) => entry.elapsedMs)
        .filter((value) => typeof value === 'number');
    const totalDuration = durations.reduce((acc, value) => acc + value, 0);
    const averageMs = durations.length ? totalDuration / durations.length : null;
    const fastCount = durations.filter((value) => value <= FAST_THRESHOLD_MS).length;
    const fastRatio = durations.length ? fastCount / durations.length : null;
    const explanationCount = bridgeExplanationStore.size;
    const explanationCoverage = total > 0 ? explanationCount / total : 0;

    if (bridgeSummaryCount) {
        bridgeSummaryCount.textContent = `${completed} / ${total}`;
    }
    if (bridgeSummaryAccuracy) {
        bridgeSummaryAccuracy.textContent = `${accuracy}%`;
    }
    if (bridgeSummaryAverage) {
        if (averageMs === null) {
            bridgeSummaryAverage.textContent = 'â€”';
        } else {
            bridgeSummaryAverage.textContent = `${(averageMs / 1000).toFixed(1)}ì´ˆ`;
        }
    }
    if (bridgeSummaryFast) {
        if (fastRatio === null) {
            bridgeSummaryFast.textContent = 'â€”';
        } else {
            bridgeSummaryFast.textContent = `${Math.round(fastRatio * 100)}%`;
        }
    }
    if (bridgeSummaryExplanation) {
        bridgeSummaryExplanation.textContent = `${Math.round(explanationCoverage * 100)}% (${explanationCount}ê°œ)`;
    }

    if (bridgeSummaryNote) {
        bridgeSummaryNote.textContent =
            completed === total
                ? 'ëª¨ë“  ë‹¨ê³„ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ì—°ìŠµ ë¬¸ì œì—ì„œ ë‹¤ë£¬ ê·œì¹™ì„ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ì—°ê²°í•´ë³´ì„¸ìš”.'
                : 'ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ë©´ ìš”ì•½ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.';
    }

    if (completed === total) {
        bridgeSummary.classList.remove('hidden');
    }
}

function updateBridgeStatusMessage() {
    if (!bridgeStatus) {
        return;
    }
    const total = bridgeProblems.length;
    const completed = Array.from(bridgeResults.values()).filter((entry) => entry.correct).length;
    if (completed === 0) {
        bridgeStatus.textContent = 'í‘œ(P) â†’ ì„¤ëª…(C) â†’ ì‹(A) ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤. ê° ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ê°€ ê°•ì¡°ë©ë‹ˆë‹¤.';
        return;
    }
    if (completed < total) {
        bridgeStatus.textContent = `${completed}/${total} ë‹¨ê³„ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì§„í–‰í•´ë³´ì„¸ìš”.`;
        return;
    }
    bridgeStatus.textContent = 'S2 ë¸Œë¦¬ì§€ ë¯¸ë‹ˆ ìœ ë‹›ì„ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ì´ì œ ì¼ë°˜í•­ì„ í™œìš©í•´ ë” ë³µì¡í•œ ë¬¸ì œì— ë„ì „í•´ë³´ì„¸ìš”.';
}

function sanitizeNumber(value) {
    if (typeof value !== 'string') {
        return Number(value);
    }
    const trimmed = value.trim();
    if (trimmed === '') {
        return NaN;
    }
    return Number(trimmed);
}

function handleBridgeSubmission(article) {
    const problemId = article.dataset.bridgeId || '';
    const problemType = article.dataset.bridgeType || '';
    if (!problemId || !problemType) {
        return;
    }
    const alreadyCompleted = bridgeResults.get(problemId);
    if (alreadyCompleted && alreadyCompleted.correct) {
        setBridgeFeedback(article, 'ì´ë¯¸ ì™„ë£Œëœ ë‹¨ê³„ì…ë‹ˆë‹¤.', 'text-slate-300');
        return;
    }

    if (problemType === 'table_fill') {
        const missingCell = article.querySelector('[data-bridge-input="missing"]');
        const missingField = article.querySelector('[data-bridge-input="missing-value"]');
        const differenceField = article.querySelector('[data-bridge-input="difference"]');
        const rawMissing = missingField ? missingField.value : (missingCell ? missingCell.value : '');
        const rawDifference = differenceField ? differenceField.value : '';
        const missingValue = sanitizeNumber(rawMissing);
        const differenceValue = sanitizeNumber(rawDifference);
        if (!Number.isFinite(missingValue)) {
            setBridgeFeedback(article, 'ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ ê°’ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'text-amber-300');
            return;
        }
        if (!Number.isFinite(differenceValue)) {
            setBridgeFeedback(article, 'ê³µì°¨ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'text-amber-300');
            return;
        }
        const expectedMissing = Number(article.dataset.answerMissing);
        const expectedDifference = Number(article.dataset.answerDifference);
        if (missingValue !== expectedMissing || differenceValue !== expectedDifference) {
            setBridgeFeedback(article, 'ì˜¤ë‹µì…ë‹ˆë‹¤. ê³µì°¨ì™€ ë¹ˆì¹¸ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.', 'text-rose-300');
            return;
        }
        if (missingCell) {
            missingCell.value = String(expectedMissing);
            missingCell.disabled = true;
        }
        if (missingField) {
            missingField.value = String(expectedMissing);
            missingField.disabled = true;
        }
        if (differenceField) {
            differenceField.value = String(expectedDifference);
            differenceField.disabled = true;
        }
        const elapsedMs = finishBridgeTimer(problemId);
        bridgeResults.set(problemId, {
            correct: true,
            elapsedMs,
        });
        setBridgeFeedback(article, 'ì •ë‹µì…ë‹ˆë‹¤! ê³µì°¨ë¥¼ ì •í™•íˆ ì°¾ì•˜ì–´ìš” ğŸ‘', 'text-emerald-300');
        trackBridgeAnalytics('bridge_step_complete', {
            step: problemId,
            type: problemType,
            elapsed_ms: elapsedMs,
        });
    } else if (problemType === 'explain') {
        const explanationField = article.querySelector('[data-bridge-input="explanation"]');
        if (!explanationField) {
            return;
        }
        const text = explanationField.value.trim();
        if (!text) {
            setBridgeFeedback(article, 'ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ì²« í•­ê³¼ ê³µì°¨ë¥¼ ì–¸ê¸‰í•˜ë©´ ì¢‹ì•„ìš”.', 'text-amber-300');
            return;
        }
        const keywords = (article.dataset.answerKeywords || '')
            .split('|')
            .map((keyword) => keyword.trim())
            .filter(Boolean);
        const lower = text.toLowerCase();
        const missingKeywords = keywords.filter((keyword) => !lower.includes(keyword.toLowerCase()));
        if (missingKeywords.length) {
            setBridgeFeedback(
                article,
                `ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ìŒ í‚¤ì›Œë“œë¥¼ í¬í•¨í•´ë³´ì„¸ìš”: ${missingKeywords.join(', ')}`,
                'text-rose-300',
            );
            return;
        }
        explanationField.value = text;
        explanationField.disabled = true;
        const elapsedMs = finishBridgeTimer(problemId);
        bridgeResults.set(problemId, {
            correct: true,
            elapsedMs,
        });
        bridgeExplanationStore.set(problemId, {
            text,
            keyword_count: keywords.length,
        });
        setBridgeFeedback(article, 'ì¢‹ì•„ìš”! í•µì‹¬ì–´ê°€ ëª¨ë‘ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‘', 'text-emerald-300');
        trackBridgeAnalytics('bridge_step_complete', {
            step: problemId,
            type: problemType,
            elapsed_ms: elapsedMs,
            keyword_count: keywords.length,
        });
    } else if (problemType === 'general_term') {
        const termField = article.querySelector('[data-bridge-input="term-value"]');
        if (!termField) {
            return;
        }
        const termValue = sanitizeNumber(termField.value);
        if (!Number.isFinite(termValue)) {
            setBridgeFeedback(article, 'aâ‚™ ê°’ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'text-amber-300');
            return;
        }
        const expectedValue = Number(article.dataset.answerValue);
        if (termValue !== expectedValue) {
            setBridgeFeedback(article, 'ì˜¤ë‹µì…ë‹ˆë‹¤. ê³µì‹ aâ‚™ = aâ‚ + (n-1)dë¥¼ í™œìš©í•´ë³´ì„¸ìš”.', 'text-rose-300');
            return;
        }
        termField.value = String(expectedValue);
        termField.disabled = true;
        const elapsedMs = finishBridgeTimer(problemId);
        bridgeResults.set(problemId, {
            correct: true,
            elapsedMs,
        });
        setBridgeFeedback(article, 'ì •ë‹µì…ë‹ˆë‹¤! ì¼ë°˜í•­ì„ ì •í™•íˆ ê³„ì‚°í–ˆì–´ìš” ğŸ‰', 'text-emerald-300');
        trackBridgeAnalytics('bridge_step_complete', {
            step: problemId,
            type: problemType,
            elapsed_ms: elapsedMs,
        });
    } else {
        return;
    }

    article.classList.add('border-primary/60', 'bg-primary/5');
    updateBridgeProgress();
    updateBridgeSummary();
    updateBridgeStatusMessage();

    const index = Number(article.dataset.bridgeIndex || '0');
    const nextArticle = bridgeProblems[index + 1];
    if (nextArticle) {
        nextArticle.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (bridgeSummary) {
        bridgeSummary.classList.remove('hidden');
        bridgeSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function bindBridgeProblem(article) {
    const problemId = article.dataset.bridgeId || '';
    const form = article.querySelector('[data-bridge-form]');
    if (!problemId || !form) {
        return;
    }
    const boundInputs = Array.from(form.querySelectorAll('input, textarea'));
    const embeddedInputs = Array.from(article.querySelectorAll('table [data-bridge-input="missing"]'));
    const allInputs = [...boundInputs, ...embeddedInputs];

    allInputs.forEach((input) => {
        input.addEventListener('focus', () => {
            startBridgeTimer(problemId);
        });
        if (input.dataset.bridgeInput === 'missing-value') {
            input.addEventListener('input', () => {
                const mirror = article.querySelector('[data-bridge-input="missing"]');
                if (mirror && mirror !== input) {
                    mirror.value = input.value;
                }
            });
        }
        if (input.dataset.bridgeInput === 'missing') {
            input.addEventListener('input', () => {
                const mirror = article.querySelector('[data-bridge-input="missing-value"]');
                if (mirror && mirror !== input) {
                    mirror.value = input.value;
                }
            });
        }
    });

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        handleBridgeSubmission(article);
    });
}

function setFeedback(feedbackEl, message, toneClass) {
    if (!feedbackEl) {
        return;
    }
    feedbackEl.textContent = message;
    feedbackEl.className = `mt-3 text-sm font-semibold ${toneClass}`;
}

function extractErrorMessage(payload) {
    if (!payload) {
        return 'ë‹µì•ˆì„ ì±„ì í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    if (typeof payload.detail === 'string') {
        return payload.detail;
    }
    if (Array.isArray(payload.detail) && payload.detail[0] && payload.detail[0].msg) {
        return payload.detail[0].msg;
    }
    if (payload.detail && typeof payload.detail.detail === 'string') {
        return payload.detail.detail;
    }
    if (typeof payload.message === 'string') {
        return payload.message;
    }
    return 'ë‹µì•ˆì„ ì±„ì í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
}

async function submitAttempt(problemId, answer) {
    const response = await fetch(`/api/problems/${encodeURIComponent(problemId)}/attempts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({ answer }),
    });

    let payload = null;
    const contentType = response.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
        payload = await response.json();
    }

    if (!response.ok) {
        const error = new Error(extractErrorMessage(payload));
        error.payload = payload;
        error.status = response.status;
        throw error;
    }

    return payload;
}

async function handleCheck(card) {
    const button = card.querySelector('[data-check]');
    const input = card.querySelector('[data-input]');
    const feedback = card.querySelector('[data-feedback]');
    const problemId = card.dataset.problemId || '';
    const rawValue = input ? input.value : '';
    const trimmed = rawValue.trim();
    const userAnswer = Number(trimmed);
    const explanationInput = card.querySelector('[data-explanation]');
    const explanationValue = explanationInput ? (explanationInput.value || '').trim() : '';
    const hasExplanation = explanationValue.length > 0;

    if (!problemId) {
        setFeedback(feedback, 'ë¬¸ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-amber-300');
        return;
    }

    if (trimmed === '' || !Number.isFinite(userAnswer)) {
        setFeedback(feedback, 'ë‹µì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'text-amber-300');
        answered.delete(problemId);
        reactionTimes.delete(problemId);
        renderSummary();
        return;
    }

    if (button) {
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
    }

    const timing = attemptTimings.get(problemId);
    let reactionMs = null;
    if (timing && typeof timing.startedAt === 'number') {
        reactionMs = Math.max(0, performance.now() - timing.startedAt);
    }
    if (hasExplanation) {
        explanations.set(problemId, explanationValue);
    } else {
        explanations.delete(problemId);
    }

    try {
        const payload = await submitAttempt(problemId, userAnswer);
        const isCorrect = Boolean(payload && payload.is_correct);
        if (isCorrect) {
            setFeedback(feedback, 'ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš” ğŸ‰', 'text-emerald-300');
        } else {
            const correctAnswer = payload ? payload.correct_answer : undefined;
            const hint = correctAnswer !== undefined ? `ì •ë‹µì€ ${correctAnswer} ì…ë‹ˆë‹¤.` : 'ë‹¤ì‹œ í•œë²ˆ ë„ì „í•´ë³´ì„¸ìš”!';
            setFeedback(feedback, `ì˜¤ë‹µì…ë‹ˆë‹¤. ${hint}`, 'text-rose-300');
        }
        answered.set(problemId, isCorrect);
        if (reactionMs !== null) {
            reactionTimes.set(problemId, reactionMs);
            const elapsedMs = Number(reactionMs.toFixed(2));
            trackProblemRTEvent({
                problem_id: problemId,
                category: currentCategory || 'unknown',
                elapsed_ms: elapsedMs,
                is_correct: isCorrect,
                source: 'api',
            });
        } else {
            reactionTimes.delete(problemId);
        }
        if (hasExplanation) {
            trackProblemExplanationEvent({
                problem_id: problemId,
                category: currentCategory || 'unknown',
                length: explanationValue.length,
            });
        }
    } catch (error) {
        const fallbackProblem = Array.isArray(problemData)
            ? problemData.find((entry) => entry && entry.id === problemId)
            : null;
        if (fallbackProblem && typeof fallbackProblem.answer === 'number') {
            const correctAnswer = Number(fallbackProblem.answer);
            const isCorrect = userAnswer === correctAnswer;
            const statusMessage = isCorrect
                ? 'ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš” ğŸ‰ (ì„ì‹œ ì±„ì )'
                : `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì€ ${correctAnswer} ì…ë‹ˆë‹¤. (ì„ì‹œ ì±„ì )`;
            setFeedback(feedback, statusMessage, isCorrect ? 'text-emerald-300' : 'text-rose-300');
            answered.set(problemId, isCorrect);
            if (reactionMs !== null) {
                reactionTimes.set(problemId, reactionMs);
                const elapsedMs = Number(reactionMs.toFixed(2));
                trackProblemRTEvent({
                    problem_id: problemId,
                    category: currentCategory || 'unknown',
                    elapsed_ms: elapsedMs,
                    is_correct: isCorrect,
                    source: 'fallback',
                });
            } else {
                reactionTimes.delete(problemId);
            }
            if (hasExplanation) {
                trackProblemExplanationEvent({
                    problem_id: problemId,
                    category: currentCategory || 'unknown',
                    length: explanationValue.length,
                    source: 'fallback',
                });
            }
        } else {
            const message = error instanceof Error ? error.message : 'ë‹µì•ˆì„ ì±„ì í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            setFeedback(feedback, message, 'text-amber-300');
            answered.delete(problemId);
            reactionTimes.delete(problemId);
        }
    } finally {
        if (button) {
            button.disabled = false;
            button.removeAttribute('aria-busy');
        }
        attemptTimings.delete(problemId);
        renderSummary();
    }
}

function focusNextProblem(currentCard) {
    const currentIndex = problemCards.indexOf(currentCard);
    if (currentIndex === -1) {
        return;
    }
    const nextCard = problemCards[currentIndex + 1];
    if (!nextCard) {
        return;
    }
    const nextInput = nextCard.querySelector('[data-input]');
    if (nextInput instanceof HTMLElement) {
        nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        nextInput.focus();
        if (typeof nextInput.select === 'function') {
            nextInput.select();
        }
    }
}

async function checkAndAdvance(card) {
    await handleCheck(card);
    focusNextProblem(card);
}

function bindCard(card) {
    const button = card.querySelector('[data-check]');
    const form = card.querySelector('[data-problem-form]');
    const input = card.querySelector('[data-input]');
    const explanationField = card.querySelector('[data-explanation]');
    const problemId = card.dataset.problemId || '';
    if (button) {
        button.addEventListener('click', () => {
            void handleCheck(card);
        });
    }
    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            void checkAndAdvance(card);
        });
    }
    if (input) {
        input.addEventListener('focus', () => {
            markProblemStart(problemId);
        });
        input.addEventListener('input', () => {
            if (!attemptTimings.has(problemId)) {
                markProblemStart(problemId);
            }
        }, { once: true });
    }
    if (explanationField) {
        explanationField.addEventListener('focus', () => {
            if (!attemptTimings.has(problemId)) {
                markProblemStart(problemId);
            }
        });
    }
}

problemCards.forEach(bindCard);
renderSummary();

if (bridgeSection && bridgeProblems.length) {
    bridgeProblems.forEach((article) => bindBridgeProblem(article));
    updateBridgeProgress();
    updateBridgeStatusMessage();
    updateBridgeSummary();
}

const resetButton = document.querySelector('[data-reset]');
if (resetButton) {
    resetButton.addEventListener('click', () => {
        answered.clear();
        explanations.clear();
        attemptTimings.clear();
        reactionTimes.clear();
        problemCards.forEach((card) => {
            const input = card.querySelector('[data-input]');
            const feedback = card.querySelector('[data-feedback]');
            const explanationField = card.querySelector('[data-explanation]');
            if (input) {
                input.value = '';
            }
            if (explanationField) {
                explanationField.value = '';
            }
            if (feedback) {
                feedback.textContent = '';
                feedback.className = 'mt-3 text-sm text-slate-300';
            }
        });
        renderSummary();
    });
}

const inviteSection = document.querySelector('[data-invite-section]');
if (inviteSection) {
    const rawCategoryName = (inviteSection.dataset.category || '').trim();
    const hasValidCategory = (inviteSection.dataset.categoryAvailable || 'false') === 'true' && rawCategoryName !== '';
    const categoryName = hasValidCategory ? rawCategoryName : null;
    const inviteGenerateButton = inviteSection.querySelector('[data-invite-generate]');
    const inviteCopyButton = inviteSection.querySelector('[data-invite-copy]');
    const inviteExpireButton = inviteSection.querySelector('[data-invite-expire]');
    const inviteResult = inviteSection.querySelector('[data-invite-result]');
    const inviteStatus = inviteSection.querySelector('[data-invite-status]');
    const inviteUrlElement = inviteSection.querySelector('[data-invite-url]');
    const inviteExpiryElement = inviteSection.querySelector('[data-invite-expiry]');
    const inviteQrImage = inviteSection.querySelector('[data-invite-qr]');
    const inviteSummaryTotal = inviteSection.querySelector('[data-invite-summary-total]');
    const inviteSummaryCorrect = inviteSection.querySelector('[data-invite-summary-correct]');
    const inviteSummaryAccuracy = inviteSection.querySelector('[data-invite-summary-accuracy]');
    const inviteSummaryAverage = inviteSection.querySelector('[data-invite-summary-average]');
    const inviteSummaryFast = inviteSection.querySelector('[data-invite-summary-fast]');
    const inviteSummaryExplanation = inviteSection.querySelector('[data-invite-summary-explanation]');
    const inviteGenerateLabel = inviteGenerateButton ? inviteGenerateButton.querySelector('[data-label]') : null;
    let inviteState = null;

    const defaultLabel = inviteGenerateButton && inviteGenerateButton.dataset && inviteGenerateButton.dataset.labelDefault
        ? inviteGenerateButton.dataset.labelDefault
        : 'ì´ˆëŒ€ ë§í¬ ìƒì„±';
    const refreshLabel = inviteGenerateButton && inviteGenerateButton.dataset && inviteGenerateButton.dataset.labelRefresh
        ? inviteGenerateButton.dataset.labelRefresh
        : 'ì´ˆëŒ€ ë§í¬ ë‹¤ì‹œ ìƒì„±';

    function setInviteStatus(message, tone = 'info') {
        if (!inviteStatus) {
            return;
        }
        const baseClass = 'mt-4 text-sm font-medium';
        const toneClass = {
            success: 'text-emerald-300',
            error: 'text-rose-300',
            warning: 'text-amber-300',
            info: 'text-slate-300',
            neutral: 'text-slate-400',
        }[tone] || 'text-slate-300';
        inviteStatus.className = `${baseClass} ${toneClass}`;
        inviteStatus.textContent = message;
    }

    function resetInviteState() {
        inviteState = null;
        if (inviteCopyButton) {
            inviteCopyButton.disabled = true;
        }
        if (inviteExpireButton) {
            inviteExpireButton.disabled = true;
        }
        if (inviteResult) {
            inviteResult.classList.add('hidden');
        }
        if (inviteGenerateButton && inviteGenerateLabel) {
            inviteGenerateButton.disabled = !hasValidCategory;
            if (inviteGenerateButton.disabled) {
                inviteGenerateButton.setAttribute('aria-disabled', 'true');
            } else {
                inviteGenerateButton.removeAttribute('aria-disabled');
            }
            inviteGenerateLabel.textContent = defaultLabel;
        }
        if (inviteUrlElement) {
            inviteUrlElement.textContent = 'ì´ˆëŒ€ ë§í¬ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            inviteUrlElement.setAttribute('href', '#');
        }
        if (inviteExpiryElement) {
            inviteExpiryElement.textContent = 'â€”';
        }
        if (inviteQrImage) {
            inviteQrImage.classList.add('hidden');
            inviteQrImage.removeAttribute('src');
        }
        if (inviteSummaryTotal) {
            inviteSummaryTotal.textContent = '0';
        }
        if (inviteSummaryCorrect) {
            inviteSummaryCorrect.textContent = '0';
        }
        if (inviteSummaryAccuracy) {
            inviteSummaryAccuracy.textContent = '0%';
        }
        if (inviteSummaryAverage) {
            inviteSummaryAverage.textContent = 'â€”';
        }
        if (inviteSummaryFast) {
            inviteSummaryFast.textContent = 'â€”';
        }
        if (inviteSummaryExplanation) {
            inviteSummaryExplanation.textContent = 'â€”';
        }
    }

    function toggleGenerateLoading(isLoading) {
        if (!inviteGenerateButton || !inviteGenerateLabel) {
            return;
        }
        const shouldDisable = isLoading || !hasValidCategory;
        inviteGenerateButton.disabled = shouldDisable;
        if (shouldDisable) {
            inviteGenerateButton.setAttribute('aria-disabled', 'true');
        } else {
            inviteGenerateButton.removeAttribute('aria-disabled');
        }
        if (isLoading) {
            inviteGenerateLabel.textContent = 'ìƒì„± ì¤‘â€¦';
        } else if (inviteState) {
            inviteGenerateLabel.textContent = refreshLabel;
        } else {
            inviteGenerateLabel.textContent = defaultLabel;
        }
    }

    function computeInviteSummary() {
        const metrics = collectSessionMetrics();
        const averageMs = metrics.averageMs !== null ? Math.round(metrics.averageMs) : null;
        const fastRatio = metrics.fastRatio !== null ? Number(metrics.fastRatio.toFixed(3)) : null;
        const explanationCoverage = Number(metrics.explanationCoverage.toFixed(3));
        return {
            total: metrics.total,
            correct: metrics.correctCount,
            average_ms: averageMs,
            fast_ratio: fastRatio,
            explanation_count: metrics.explanationCount,
            explanation_coverage: explanationCoverage,
        };
    }

    function formatDateTime(isoString) {
        try {
            const locale = navigator.language || 'ko-KR';
            const formatter = new Intl.DateTimeFormat(locale, { dateStyle: 'medium', timeStyle: 'short' });
            return formatter.format(new Date(isoString));
        } catch (error) {
            return isoString;
        }
    }

    function updateInviteState(data) {
        inviteState = data;
        if (inviteResult) {
            inviteResult.classList.remove('hidden');
        }
        if (inviteCopyButton) {
            inviteCopyButton.disabled = false;
        }
        if (inviteExpireButton) {
            inviteExpireButton.disabled = false;
        }
        if (inviteUrlElement && data.share_url) {
            inviteUrlElement.textContent = data.share_url;
            inviteUrlElement.setAttribute('href', data.share_url);
        }
        if (inviteExpiryElement && data.expires_at) {
            inviteExpiryElement.textContent = formatDateTime(data.expires_at);
        }
        if (inviteQrImage && data.share_url) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(data.share_url)}`;
            inviteQrImage.setAttribute('src', qrUrl);
            inviteQrImage.classList.remove('hidden');
        }
        if (inviteSummaryTotal && data.summary && data.summary.total != null) {
            inviteSummaryTotal.textContent = String(data.summary.total);
        }
        if (inviteSummaryCorrect && data.summary && data.summary.correct != null) {
            inviteSummaryCorrect.textContent = String(data.summary.correct);
        }
        if (inviteSummaryAccuracy && data.summary && data.summary.accuracy != null) {
            inviteSummaryAccuracy.textContent = `${data.summary.accuracy}%`;
        }
        if (inviteSummaryAverage) {
            if (data.summary && data.summary.average_ms != null) {
                const seconds = (Number(data.summary.average_ms) / 1000).toFixed(1);
                inviteSummaryAverage.textContent = `${seconds}ì´ˆ`;
            } else {
                inviteSummaryAverage.textContent = 'â€”';
            }
        }
        if (inviteSummaryFast) {
            if (data.summary && data.summary.fast_ratio != null) {
                const percent = Math.round(Number(data.summary.fast_ratio) * 100);
                inviteSummaryFast.textContent = `${percent}%`;
            } else {
                inviteSummaryFast.textContent = 'â€”';
            }
        }
        if (inviteSummaryExplanation) {
            if (data.summary && data.summary.explanation_coverage != null) {
                const percent = Math.round(Number(data.summary.explanation_coverage) * 100);
                const count = data.summary.explanation_count;
                const label = typeof count === 'number' ? `${percent}% (${count}ê°œ)` : `${percent}%`;
                inviteSummaryExplanation.textContent = label;
            } else {
                inviteSummaryExplanation.textContent = 'â€”';
            }
        }
    }

    async function handleInviteGenerate() {
        if (!inviteGenerateButton) {
            return;
        }
        if (!hasValidCategory || !categoryName) {
            setInviteStatus('í˜„ì¬ í™œì„±í™”ëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ì–´ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            toggleGenerateLoading(false);
            return;
        }
        toggleGenerateLoading(true);
        setInviteStatus('ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
        try {
            const summary = computeInviteSummary();
            const accuracy = summary.total === 0 ? 0 : Math.round((summary.correct / summary.total) * 100);
            const fastRatioValue = typeof summary.fast_ratio === 'number' ? summary.fast_ratio : null;
            const explanationCoverageValue = typeof summary.explanation_coverage === 'number'
                ? summary.explanation_coverage
                : 0;
            const accuracyPass = accuracy >= MIN_ACCURACY_PERCENT;
            const rtPass = fastRatioValue !== null && fastRatioValue >= FAST_RATIO_THRESHOLD;
            const explanationPass = explanationCoverageValue >= EXPLANATION_COVERAGE_THRESHOLD;

            if (!accuracyPass || !(rtPass || explanationPass)) {
                const reasons = [];
                if (!accuracyPass) {
                    reasons.push(`ì •í™•ë„ ${accuracy}% (ëª©í‘œ ${MIN_ACCURACY_PERCENT}%+)`);
                }
                if (!(rtPass || explanationPass)) {
                    if (!rtPass) {
                        if (fastRatioValue === null) {
                            reasons.push('ë°˜ì‘ì‹œê°„ ë°ì´í„°ë¥¼ ì¶©ë¶„íˆ ëª¨ìœ¼ëŠ” ì¤‘ì…ë‹ˆë‹¤. ëª‡ ë¬¸ì œë§Œ ë” í’€ì–´ì£¼ì„¸ìš”.');
                        } else {
                            const fastPercent = Math.round(fastRatioValue * 100);
                            reasons.push(`ë¹ ë¥¸ ì‘ë‹µ ${fastPercent}% (ëª©í‘œ ${Math.round(FAST_RATIO_THRESHOLD * 100)}%+)`);
                        }
                    }
                    if (!explanationPass) {
                        const explainPercent = Math.round(explanationCoverageValue * 100);
                        reasons.push(`ì„¤ëª… ì…ë ¥ë¥  ${explainPercent}% (ëª©í‘œ ${Math.round(EXPLANATION_COVERAGE_THRESHOLD * 100)}%+)`);
                    }
                }
                setInviteStatus(`Invite ìƒì„± ì¡°ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${reasons.join(' / ')}`, 'warning');
                toggleGenerateLoading(false);
                return;
            }

            const payload = {
                category: categoryName,
                summary: {
                    total: summary.total,
                    correct: summary.correct,
                    average_ms: summary.average_ms,
                    fast_ratio: summary.fast_ratio,
                    explanation_count: summary.explanation_count,
                    explanation_coverage: summary.explanation_coverage,
                },
            };
            const response = await fetch('/api/invites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const errorMessage = errorBody.detail || 'ì´ˆëŒ€ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(errorMessage);
            }
            const data = await response.json();
            updateInviteState(data);
            setInviteStatus('ì´ˆëŒ€ ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ë³µì‚¬í•˜ê±°ë‚˜ QR ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”!', 'success');
            toggleGenerateLoading(false);
        } catch (error) {
            console.error(error);
            setInviteStatus(error && error.message ? error.message : 'ì´ˆëŒ€ ë§í¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            toggleGenerateLoading(false);
        }
    }

    async function handleInviteCopy() {
        if (!inviteState || !inviteState.share_url) {
            return;
        }
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(inviteState.share_url);
                setInviteStatus('ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                const tempInput = document.createElement('input');
                tempInput.value = inviteState.share_url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                setInviteStatus('ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', 'success');
            }
        } catch (error) {
            console.error(error);
            setInviteStatus('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'warning');
        }
    }

    async function handleInviteExpire() {
        if (!inviteState || !inviteState.token) {
            return;
        }
        setInviteStatus('ì´ˆëŒ€ ë§í¬ë¥¼ ë§Œë£Œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'info');
        try {
            const response = await fetch(`/api/invites/${inviteState.token}`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                throw new Error('ì´ˆëŒ€ ë§Œë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            resetInviteState();
            setInviteStatus('ì´ˆëŒ€ ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ìƒˆë¡œ ìƒì„±í•˜ì„¸ìš”.', 'neutral');
        } catch (error) {
            console.error(error);
            setInviteStatus(error && error.message ? error.message : 'ì´ˆëŒ€ ë§í¬ ë§Œë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    if (inviteGenerateButton) {
        inviteGenerateButton.addEventListener('click', handleInviteGenerate);
    }
    if (inviteCopyButton) {
        inviteCopyButton.addEventListener('click', handleInviteCopy);
    }
    if (inviteExpireButton) {
        inviteExpireButton.addEventListener('click', handleInviteExpire);
    }

    resetInviteState();
    if (!hasValidCategory) {
        setInviteStatus('í˜„ì¬ ì„ íƒëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ì–´ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    setInviteStatus('ì •í™•ë„ 85% ì´ìƒì´ê³ , ë¹ ë¥¸ ì‘ë‹µ(40%+) ë˜ëŠ” ì„¤ëª… ì…ë ¥ë¥  50% ì´ìƒì´ë©´ Inviteë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
}
</script>
{% endblock %}
